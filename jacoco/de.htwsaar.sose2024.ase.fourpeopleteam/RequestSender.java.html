<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestSender.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HTW Saar Java chatbot</a> &gt; <a href="index.source.html" class="el_package">de.htwsaar.sose2024.ase.fourpeopleteam</a> &gt; <span class="el_source">RequestSender.java</span></div><h1>RequestSender.java</h1><pre class="source lang-java linenums">package de.htwsaar.sose2024.ase.fourpeopleteam;

import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpRequest.BodyPublisher;
import java.net.http.HttpRequest.BodyPublishers;
import java.net.http.HttpResponse;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

/** The class RequestSender  manages the sending of HTTP requests to a server
 *  to obtain responses for the chatbot's conversation. */
public class RequestSender {
  private String baseUrl;
<span class="fc" id="L19">  public static int MAX_ATTEMPTS = 3;</span>

<span class="fc" id="L21">  public RequestSender(String baseUrl) {</span>
<span class="fc" id="L22">    this.baseUrl = baseUrl;</span>
<span class="fc" id="L23">  }</span>


  /** Requests the next message in a conversation to the server and returns the new message. */
  public Conversation.Message requestNextMessage(Conversation conversation)
      throws ChatbotException {
<span class="fc" id="L29">    String requestBody = encodeRequest(conversation);</span>
<span class="fc" id="L30">    String responseBody = null;</span>
    int i;
<span class="pc bpc" id="L32" title="1 of 2 branches missed.">    for (i = 0; i &lt; MAX_ATTEMPTS; i++) {</span>
      try {
<span class="fc" id="L34">        responseBody = attemptSendingMessage(requestBody);</span>
<span class="fc" id="L35">        break;</span>
<span class="nc" id="L36">      } catch (URISyntaxException e) {</span>
<span class="nc" id="L37">        throw new RuntimeException(e);</span>
<span class="nc" id="L38">      } catch (IOException | InterruptedException e) {</span>
        //do nothing, try again
      }
    }

<span class="pc bpc" id="L43" title="1 of 2 branches missed.">    if (i == MAX_ATTEMPTS) {</span>
<span class="nc" id="L44">      throw new ChatbotException(&quot;request limit exceeded&quot;);</span>
    }

<span class="fc" id="L47">    Conversation.Message message = decodeResponse(responseBody);</span>
<span class="fc" id="L48">    return message;</span>
  }

  /** Decodes a String response from the server into a Conversation.Message object.
   *
   * @param response The JSON response string
   * @return The new message returned by the server
   * @throws ChatbotException if something went wrong
   */
  public static Conversation.Message decodeResponse(String response)
      throws ChatbotException {
    try {
      //cast to JSON
<span class="fc" id="L61">      JSONObject jsonResponse = new JSONObject(response);</span>
      //pick from the response choices
<span class="fc" id="L63">      JSONArray choices = jsonResponse.optJSONArray(&quot;choices&quot;);</span>
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">      if (choices == null) {</span>
<span class="nc" id="L65">        throw new ChatbotException(&quot;null choices&quot;);</span>
      }
      //get first choice
<span class="fc" id="L68">      JSONObject firstChoice = choices.getJSONObject(0);</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">      if (firstChoice == null) {</span>
<span class="nc" id="L70">        throw new ChatbotException(&quot;null first choice&quot;);</span>
      }
<span class="fc" id="L72">      JSONObject jsonMessage = firstChoice.getJSONObject(&quot;message&quot;);</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">      if (jsonMessage == null) {</span>
<span class="nc" id="L74">        throw new ChatbotException(&quot;null json message&quot;);</span>
      }
      //then convert to Conversation.Message
<span class="fc" id="L77">      return Conversation.Message.fromJsonObject(jsonMessage);</span>
<span class="nc" id="L78">    } catch (JSONException e) {</span>
<span class="nc" id="L79">      throw new ChatbotException(e);</span>
    }
  }

  /** Encodes a conversation into a JSON request String which can be sent to the server.
   *
   * @param conversation the conversation to be encoded
   * @return the JSON request to be sent to the server
   */
  public static String encodeRequest(Conversation conversation) {
<span class="fc" id="L89">    JSONObject conv = new JSONObject();</span>
<span class="fc" id="L90">    conv.put(&quot;messages&quot;, conversation.toJson());</span>
<span class="fc" id="L91">    conv.put(&quot;max_tokens&quot;, 256);</span>
<span class="fc" id="L92">    return conv.toString();</span>
  }

  /** Attempts to send a (string) message to the server's endpoint
   * and returns the response body String.
   *
   * @param bodyString the string to be sent as a request body
   * @return the response body
   */
  private String attemptSendingMessage(String bodyString)
      throws URISyntaxException, IOException, InterruptedException {
<span class="fc" id="L103">    return attemptSendingMessageTo(</span>
        bodyString,
        baseUrl + &quot;/v1/chat/completions&quot;);
  }

  /** Attempts to send a (string) message to the specified URL
   * and returns the response body String.
   *
   * @param bodyString the string to be sent as a request body
   * @param url the URL to send the body to
   * @return the response body
   */
  public String attemptSendingMessageTo(String bodyString, String url)
      throws URISyntaxException, IOException, InterruptedException {
<span class="nc" id="L117">    BodyPublisher bp = BodyPublishers.ofString(bodyString);</span>

<span class="nc" id="L119">    HttpClient client = HttpClient.newHttpClient();</span>
<span class="nc" id="L120">    HttpRequest request = HttpRequest</span>
<span class="nc" id="L121">        .newBuilder(new URI(url)).POST(bp).build();</span>

    //NOTE: synchronous
<span class="nc" id="L124">    HttpResponse&lt;String&gt; response = client.send(request, HttpResponse.BodyHandlers.ofString());</span>

<span class="nc" id="L126">    return response.body();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>